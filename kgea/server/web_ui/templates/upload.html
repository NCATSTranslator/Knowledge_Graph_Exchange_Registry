{% extends "layout.html" %}
{% block scripts %}
    <script type="text/javascript" src="https://raw.githubusercontent.com/mdix/progress.js/master/progress.js"></script>
    <link type="text/css" rel="stylesheet" href="https://github.com/mdix/progress.js/blob/master/progress.css"/>
    {#    Spinner   #}
    <style>
      .spin {
        display: none; /*default*/
        width: 1em;
        height: 1em;
        border: 3px solid rgba(255, 255, 255, .3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        -webkit-animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to {
          -webkit-transform: rotate(360deg);
        }
      }
      @-webkit-keyframes spin {
        to {
          -webkit-transform: rotate(360deg);
        }
      }
    </style>
    <script>
        /* UI Elements */
        // Progress Bar //
        progressBar = Progress.bar(configObj);
        progressBar.renderTo(document.getElementById('percentage'))

        let content_name = 'unknown';
        function SetFileName(value) {
            // TODO: Sanitize content_names as per AWS Object Key naming guidelines?
            // https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-keys.html
            content_name = value;
        }

        async function GetUrl(source) {
            // TODO: need a sensible heuristic here to guess a reasonable file name from a given content_url
            let url = new URL(source.value.trim());
            let pathname = url.pathname;
            if(pathname === '/') {
                content_name = Math.random().toString(16).substr(2, 8).toUpperCase()+".kgx";
            } else {
                content_name = pathname.split("/")[1];
            }
            document.getElementById("file_name").value = content_name;
            SetFileName(content_name)
        }

        async function UploadFile(source) {

            console.log("UploadFile(upload_mode: '" + source.id + "')");

            let formData = new FormData();

            formData.append("kg_id", "{{kg_id}}");
            formData.append("kg_version", "{{kg_version}}");

            let kfc_radio = document.querySelector("input[name=kgx_file_content]:checked");
            let kgx_file_content = kfc_radio ? kfc_radio.value : "";
            formData.append("kgx_file_content", kgx_file_content);

            if(!kgx_file_content) {
                window.alert("Please select KGX content type to be uploaded.");
                return;
            }

            if(kgx_file_content === "archive") {
                window.alert(
                    "Sorry, KGX 'tar.gz' compressed archives are not " +
                    "yet fully handled in the interface (coming soon!)");
                return;
            }

            formData.append("upload_mode", source.id);

            if (source.id === 'content_from_url') {

                // Transfer file from REST URL endpoint
                let content_url = document.getElementById('content_url').value;

                if(content_url) {
                    console.log("Content URL: '" + content_url + "')");
                    formData.append("content_url", content_url);
                } else  {
                    console.log("KGX content file URL is undefined?");
                    window.alert("KGX content file URL is undefined");
                    return;
                }

            } else if (source.id === 'content_from_local_file') {

                let uploaded_file = document.getElementById('content_file').files[0];
                {#content_name = uploaded_file.name;#}

                if(uploaded_file) {
                    console.log("KGX "+kgx_file_content+" file being uploaded: '" + uploaded_file.name + "'");
                    formData.append("uploaded_file", uploaded_file);

                    formData.append("content_name", uploaded_file.name);

                    document.getElementById('content_from_local_file').disabled = true;
                    document.getElementById('spinner').style.display = "inline-block";
                    document.getElementById('percentage').style.display = "inline-block";
                    document.getElementById('spinner-text').style.display = "inline-block";

                    const url =  new URL(window.location.href);
                    await fetch(`{{upload_action}}/?kg_id=${url.searchParams.get("kg_id")}&kg_version=${url.searchParams.get("kg_version")}&kgx_file_content=${kgx_file_content}&upload_mode=${source.id}&content_name=${uploaded_file.name}`,
                        {
                            method: "GET",
                            credentials: "include"
                        }
                    )
                    .then(r => r.json())
                    .then(async result => {
                        formData.append('upload_token', result.upload_token)
                        fetch(`{{upload_action}}`, {
                            method: "POST",
                            body: formData,
                            credentials: "include"
                        })
                        return result.upload_token
                    })
                    .then(async upload_token => {

                        // use mutual recursion to create a progress element that always updates the exact amount required

                        document.getElementById('percentage').textContent = `0%`;

                       async function askForProgress() {
                            return await fetch(`{{upload_action}}/progress?upload_token=${upload_token}`, { credentials: "include" })
                                .then(r => r.json())
                                .then(j => {
                                    let percentage = Math.floor((j.current_position / j.end_position) * 100);
                                    document.getElementById('percentage').textContent = `${percentage}%`;
                                    return j;
                                })
                        }

                        function later(delay, value) {
                            return new Promise(resolve => setTimeout(resolve, delay, value));
                        }

                        async function execute(callback) {
                            return await callback().then(async j => {
                                if (!(j.current_position === j.end_position)) {
                                    return await later(1000, askForProgress).then(execute)
                                }
                            })
                        }

                        await later(1000, askForProgress).then(execute);

                    })

                    document.getElementById('content_from_local_file').disabled = false;
                    document.getElementById('spinner').style.display = "none";
                    document.getElementById('percentage').style.display = "none";
                    document.getElementById('spinner-text').style.display = "none";

                } else  {
                    console.log("KGX "+kgx_file_content+" file is undefined?");
                    window.alert("KGX "+kgx_file_content+" file is undefined");
                    return;
                }
            }



        }
    </script>
{% endblock %}
{% block menu %}
{% include "logout.button" %}
{% include "home.button" %}
<div class="menu_item">
<form method="GET" action="{{publish_file_set_action}}/{{kg_id}}/{{kg_version}}">
    <input type="submit" value="Done Uploading" />
</form>
</div>
{% endblock %}
{% block title %}Upload Knowledge Graph<br>'{{kg_name}}'{% endblock %}
{% block subtitle %}Version: '{{kg_version}}', Submitted by '{{submitter}}'{% endblock %}
{% block content %}
<div class="subtitle"></div>
<table>
    <tr>
        <td rowspan="2">
            <h4>KGX Content Type</h4>
            <input type="radio" id="metadata" name="kgx_file_content" value="metadata" checked>
            <label  class="label" for="metadata">Metadata</label>
            <div class="tooltip">
                <img class="tooltip_target" src="images/help-icon.png" width="12" height="12"/>
                <span class="tooltiptext">
                    (*) Must be a valid KGX metadata JSON file generated from your dataset.
                </span>
            </div>
            <p></p>
            <input type="radio" id="nodes" name="kgx_file_content" value="nodes">
            <label class="label" for="nodes">Nodes</label>
            <div class="tooltip">
                <img class="tooltip_target" src="images/help-icon.png" width="12" height="12"/>
                <span class="tooltiptext">
                    (*) Must be valid (possibly 'gzip' compressed) KGX-compliant TSV formatted 'nodes' file.
                </span>
            </div>
            <p></p>
            <input type="radio" id="edges" name="kgx_file_content" value="edges">
            <label class="label" for="edges">Edges</label>
            <div class="tooltip">
                <img class="tooltip_target" src="images/help-icon.png" width="12" height="12"/>
                <span class="tooltiptext">
                        (*) Must be valid (possibly 'gzip' compressed) KGX-compliant TSV formatted 'edges' file.
                </span>
            </div>
            <p></p>
            <!--  -->
            <input type="radio" id="archive" name="kgx_file_content" value="archive">
            <label class="label" for="archive">KGX Archive</label>
            <div class="tooltip">
                <img class="tooltip_target" src="images/help-icon.png" width="12" height="12"/>
                <span class="tooltiptext">
                        If a KGX Archive is given, then the local
                            uploaded file or a transfer from URL is assumed to be a gzip'd
                            compressed tar file with the name 'kge.tar.gz' containing one
                            of each of both a KGX-compliant 'nodes.tsv' and 'edges.tsv'
                            file for the knowledge graph, with or without an associated
                            KGX-compliant 'metadata.json' file.
                </span>
            </div>
    <p></p>
        </td>
        <td>
            <h4>Upload from your computer</h4>

            <p>Choose a KGX content type for uploading</p>

            <label for="content_file"><b>Select File</b></label>
            <input id="content_file"  class="textbox" type="file"/>
            <button id="content_from_local_file" onclick="UploadFile(this)" >
                Upload
            </button>
            <div id="spinner" class="spin"></div>
            <span id="percentage" style="display:none;"></span>
            <span id="spinner-text" style="display:none;">Uploading file, please don't navigate away from the page...</span>

        </td>
    </tr>
    <tr>
        <td>
            <h4>Transfer from a URL</h4>

            <label for="content_url"><b>URL to File</b></label>
            <input id="content_url" type="text" oninput="GetUrl(this)"/>
            <br><label for="file_name"><b>File Name</b></label>
            <input id="file_name" type="text" onchange="SetFileName(this.value)"/>
            <button id="content_from_url" onclick="UploadFile(this)">Initiate Transfer</button>
        </td>
    </tr>
</table>
{% endblock %}
{% block app_footer %}
(*) Read more about KGX formatted (meta-)data files
<a href="https://github.com/biolink/kgx/blob/master/data-preparation.md" target="_blank">here</a>
{% endblock %}
